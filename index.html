<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flash Box Pro - V6.3 (Trackeo Completo)</title>
<link rel="icon" href="data:image/png;base64,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">
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        :root { --primary: #6366f1; --success: #22c55e; --warning: #f59e0b; --danger: #ef4444; }
        body { background: #f8fafc; font-family: 'Segoe UI', system-ui, sans-serif; color: #1e293b; padding-bottom: 70px; }
        .nav-card { cursor: pointer; border: none; border-radius: 16px; transition: all 0.3s cubic-bezier(0.4,0,0.2,1); position: relative; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); overflow: hidden; }
        .nav-card:hover { transform: translateY(-5px); box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1); }
        .view-section { display: none; padding-top: 10px; animation: fadeIn 0.3s ease; }
        .active-view { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .badge-count { position: absolute; top: 12px; right: 12px; background: rgba(255,255,255,0.3); backdrop-filter: blur(4px); border-radius: 50%; width: 28px; height: 28px; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 13px; }
        .img-thumb { width: 100%; height: 120px; object-fit: cover; cursor: pointer; background: linear-gradient(45deg, #e2e8f0, #f1f5f9); transition: transform 0.3s ease; }
        .img-thumb:hover { transform: scale(1.02); }
        .upload-zone { background: white; border-radius: 20px; padding: 25px; box-shadow: 0 8px 30px rgba(0,0,0,0.05); border: 2px dashed #e2e8f0; transition: all 0.3s ease; }
        .upload-zone.drag-over { border-color: #22c55e; background: #f0fdf4; }
        .btn-upload { border-radius: 12px; padding: 12px; font-weight: 600; transition: all 0.2s; }
        .loader { position: fixed; inset: 0; background: rgba(255,255,255,0.95); z-index: 2000; display: none; flex-direction: column; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
        .toast-container { position: fixed; top: 20px; right: 20px; z-index: 9999; }
        .toast { background: white; border-radius: 12px; padding: 16px 20px; margin-bottom: 10px; box-shadow: 0 10px 25px rgba(0,0,0,0.15); display: flex; align-items: center; gap: 12px; min-width: 300px; animation: slideInRight 0.3s ease; border-left: 5px solid; }
        .toast-success { border-left-color: var(--success); }
        .toast-error { border-left-color: var(--danger); }
        .toast-info { border-left-color: var(--primary); }
        .toast-warning { border-left-color: var(--warning); }
        @keyframes slideInRight { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        @keyframes slideOutRight { from { transform: translateX(0); opacity: 1; } to { transform: translateX(100%); opacity: 0; } }
        .modal-custom { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 1000; display: none; align-items: center; justify-content: center; padding: 20px; backdrop-filter: blur(3px); }
        .modal-content-custom { background: white; border-radius: 16px; padding: 25px; width: 90%; max-width: 500px; max-height: 80vh; overflow-y: auto; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.3); animation: modalFadeIn 0.3s ease; }
        @keyframes modalFadeIn { from { opacity: 0; transform: translateY(-20px) scale(0.95); } to { opacity: 1; transform: translateY(0) scale(1); } }
        .modal-image { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.98); z-index: 2000; display: none; align-items: center; justify-content: center; padding: 20px; }
        .modal-image-content { max-width: 90%; max-height: 90%; border-radius: 8px; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.5); transition: opacity 0.2s ease; }
        .modal-image-close { position: absolute; top: 20px; right: 20px; background: rgba(255,255,255,0.15); border: none; color: white; font-size: 24px; width: 50px; height: 50px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: background 0.2s; z-index: 2100; }
        .modal-image-close:hover { background: rgba(255,255,255,0.25); }
        .file-icon { font-size: 2.5rem; text-align: center; margin-bottom: 10px; }
        .file-pdf { color: #e53935; }
        .file-audio { color: #8e24aa; }
        .file-word { color: #2b579a; }
        .file-excel { color: #217346; }
        .file-powerpoint { color: #d24726; }
        .file-cad { color: #ff6d00; }
        .file-other { color: #757575; }
        .stats-bar { background: white; border-radius: 16px; padding: 12px 20px; margin-bottom: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px; }
        .data-usage { display: flex; align-items: center; gap: 10px; }
        .usage-bar { width: 150px; height: 8px; background: #e2e8f0; border-radius: 4px; overflow: hidden; }
        .usage-fill { height: 100%; background: linear-gradient(90deg, #22c55e, #f59e0b, #ef4444); border-radius: 4px; transition: width 0.5s ease; }
        .note-card { height: 100%; border-radius: 16px; border: none; box-shadow: 0 4px 12px rgba(0,0,0,0.05); transition: all 0.3s ease; overflow: hidden; }
        .note-card:hover { transform: translateY(-5px); box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
        .search-box { border-radius: 12px; border: 2px solid #e2e8f0; padding: 10px 15px; transition: all 0.3s; }
        .search-box:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1); }
        .text-truncate-multiline { display: -webkit-box; -webkit-line-clamp: var(--lines, 2); -webkit-box-orient: vertical; overflow: hidden; }
        .thumbnail-container { width: 100%; height: 120px; overflow: hidden; }
        .quality-slider { width: 100%; margin: 10px 0; }
        .preview-image { max-width: 100%; max-height: 300px; border-radius: 12px; box-shadow: 0 8px 20px rgba(0,0,0,0.1); cursor: pointer; }
        .dual-image-container { position: relative; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; }
        .dual-image { position: absolute; max-width: 90%; max-height: 90%; border-radius: 8px; transition: opacity 0.2s ease; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.5); cursor: zoom-in; }
        .upload-preview { background: white; border-radius: 16px; padding: 15px; margin-bottom: 20px; border: 2px solid var(--success); animation: slideDown 0.3s ease; }
        @keyframes slideDown { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: translateY(0); } }
        .size-comparison { background: #f1f5f9; border-radius: 12px; padding: 10px 15px; font-size: 0.9rem; }
        .size-original { color: var(--danger); text-decoration: line-through; opacity: 0.7; }
        .size-compressed { color: var(--success); font-weight: bold; }
        @media (max-width: 768px) { .stats-bar { flex-direction: column; align-items: flex-start; gap: 15px; } .usage-bar { width: 100%; } }
    </style>
</head>
<body>

<div class="toast-container" id="toastContainer"></div>
<div id="loader" class="loader">
    <div class="spinner-grow text-primary" style="width:3rem;height:3rem;"></div>
    <span id="loaderText" class="mt-3 fw-bold fs-5">Procesando...</span>
</div>

<!-- Modal de Notas -->
<div id="noteModal" class="modal-custom">
    <div class="modal-content-custom">
        <h5 class="fw-bold mb-3"><i class="fas fa-edit me-2 text-primary"></i>Editar Nota</h5>
        <input type="text" id="editNoteTitle" class="form-control mb-3 border-2" placeholder="T√≠tulo...">
        <textarea id="editNoteContent" class="form-control mb-3 border-2" placeholder="Contenido..." rows="8"></textarea>
        <div class="d-flex gap-2 justify-content-end">
            <button onclick="closeModal()" class="btn btn-light">Cancelar</button>
            <button onclick="saveEditedNote()" class="btn btn-primary">Guardar Cambios</button>
        </div>
    </div>
</div>

<!-- Modal de Imagen Simple -->
<div id="imageModal" class="modal-image">
    <button class="modal-image-close" onclick="closeImageModal()">√ó</button>
    <img id="modalImage" class="modal-image-content">
</div>

<!-- Modal de Compresi√≥n -->
<div id="compressionModal" class="modal-custom">
    <div class="modal-content-custom" style="max-width: 500px;">
        <h5 class="fw-bold mb-3"><i class="fas fa-compress-alt me-2 text-success"></i>Comprimir Imagen</h5>
        
        <!-- Vista previa -->
        <div class="text-center mb-3">
            <img id="compressionPreview" src="" alt="Vista previa" 
                 style="max-width: 100%; max-height: 300px; border-radius: 12px; box-shadow: 0 8px 20px rgba(0,0,0,0.1);">
            <div class="mt-2 d-flex justify-content-center gap-3">
                <span class="badge bg-light text-dark p-2">
                    <i class="fas fa-file-image me-1"></i>
                    <span id="compressionSize">0 MB</span>
                </span>
            </div>
        </div>

        <!-- Control de calidad -->
        <div class="mb-4">
            <div class="d-flex justify-content-between align-items-center mb-2">
                <label class="fw-bold">Calidad:</label>
                <span class="badge bg-success" id="qualityDisplay">80%</span>
            </div>
            <input type="range" class="quality-slider form-range" id="qualitySlider" 
                   min="10" max="100" value="80" step="1">
        </div>

        <!-- Botones -->
        <div class="d-flex gap-2">
            <button onclick="closeCompressionModal()" class="btn btn-outline-secondary flex-grow-1">
                <i class="fas fa-times me-2"></i>Cancelar
            </button>
            <button onclick="confirmUpload()" class="btn btn-success flex-grow-1">
                <i class="fas fa-upload me-2"></i>Subir Ahora
            </button>
        </div>
    </div>
</div>

<!-- Modal de Vista Previa con Mantener Pulsado -->
<div id="previewModal" class="modal-image" style="background: black;" onclick="closePreviewModal()">
    <div class="dual-image-container" onclick="event.stopPropagation()">
        <img id="modalOriginalImage" src="" class="dual-image" style="opacity: 0;" alt="Original">
        <img id="modalCompressedImage" src="" class="dual-image" style="opacity: 1;" alt="Comprimida"
             ontouchstart="showOriginal()"
             ontouchend="hideOriginal()"
             ontouchcancel="hideOriginal()"
             onmousedown="showOriginal()"
             onmouseup="hideOriginal()"
             onmouseleave="hideOriginal()">
    </div>
    <button class="modal-image-close" onclick="closePreviewModal()">√ó</button>
</div>

<div class="container py-4">
    <!-- Barra de estad√≠sticas -->
    <div class="stats-bar">
        <div>
            <h5 class="fw-bold m-0" onclick="showView('home')" style="cursor:pointer">
                <i class="fas fa-bolt me-2 text-primary"></i>Flash Box Pro
            </h5>
            <small class="text-muted">Gestor personal de archivos</small>
        </div>
        <div class="data-usage">
            <div>
                <small class="fw-bold">Consumo diario:</small>
                <div id="dataUsage" class="fw-bold">0 MB / 300 MB</div>
            </div>
            <div class="usage-bar">
                <div id="usageFill" class="usage-fill" style="width:0%"></div>
            </div>
        </div>
    </div>

    <!-- Barra de navegaci√≥n -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <button id="btnBack" class="btn btn-light border-0 rounded-pill px-4 d-none" onclick="showView('home')">
            <i class="fas fa-arrow-left me-2"></i>Volver al Inicio
        </button>
        <div id="searchContainer" class="d-none" style="width:300px;">
            <input type="text" id="searchInput" class="form-control search-box" placeholder="Buscar...">
        </div>
    </div>

    <!-- Vista home -->
    <div id="view-home" class="view-section active-view">
        <!-- Vista previa del archivo a subir (solo visible cuando hay uno pendiente) -->
        <div id="uploadPreviewContainer" style="display: none;" class="upload-preview">
            <div class="d-flex justify-content-between align-items-center mb-2">
                <h6 class="fw-bold mb-0"><i class="fas fa-file-upload me-2 text-success"></i>Archivo listo para subir:</h6>
                <button class="btn btn-sm btn-outline-danger" onclick="clearPendingUpload()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="d-flex align-items-center gap-3 flex-wrap">
                <div class="d-flex align-items-center gap-2">
                    <i class="fas fa-file-image fa-2x text-primary"></i>
                    <div>
                        <div id="pendingFileName" class="fw-bold">nombre.png</div>
                        <div class="size-comparison">
                            <span id="pendingOriginalSize" class="size-original">0 MB</span>
                            <i class="fas fa-arrow-right mx-2"></i>
                            <span id="pendingCompressedSize" class="size-compressed">0 MB</span>
                        </div>
                    </div>
                </div>
                <div class="ms-auto">
                    <button class="btn btn-success" onclick="performPendingUpload()">
                        <i class="fas fa-cloud-upload-alt me-2"></i>Subir Ahora
                    </button>
                </div>
            </div>
        </div>

        <div class="row g-3 mb-4">
            <div class="col-6 col-md-3" onclick="loadAndShow('notas')">
                <div class="card nav-card bg-primary text-white p-4">
                    <div id="count-notas" class="badge-count">0</div>
                    <div class="fs-2"><i class="fas fa-sticky-note"></i></div>
                    <b>NOTAS</b>
                </div>
            </div>
            <div class="col-6 col-md-3" onclick="loadAndShow('imagenes')">
                <div class="card nav-card bg-success text-white p-4">
                    <div id="count-imagenes" class="badge-count">0</div>
                    <div class="fs-2"><i class="fas fa-image"></i></div>
                    <b>FOTOS</b>
                </div>
            </div>
            <div class="col-6 col-md-3" onclick="loadAndShow('pdf')">
                <div class="card nav-card bg-danger text-white p-4">
                    <div id="count-pdf" class="badge-count">0</div>
                    <div class="fs-2"><i class="fas fa-file-pdf"></i></div>
                    <b>PDFs</b>
                </div>
            </div>
            <div class="col-6 col-md-3" onclick="loadAndShow('otros')">
                <div class="card nav-card bg-warning text-dark p-4">
                    <div id="count-otros" class="badge-count">0</div>
                    <div class="fs-2"><i class="fas fa-archive"></i></div>
                    <b>OTROS</b>
                </div>
            </div>
        </div>

        <!-- √Årea de subida r√°pida -->
        <div class="upload-zone" id="uploadZone">
            <h5 class="fw-bold mb-3"><i class="fas fa-cloud-upload-alt me-2 text-primary"></i>Subida R√°pida</h5>
            <div class="row g-3">
                <div class="col-md-6">
                    <div class="p-3 border rounded-4 bg-light">
                        <small class="fw-bold text-primary"><i class="fas fa-plus-circle me-1"></i>NUEVA NOTA</small>
                        <input type="text" id="noteTitle" class="form-control my-2 border-0 shadow-sm" placeholder="T√≠tulo...">
                        <textarea id="noteContent" class="form-control mb-2 border-0 shadow-sm" placeholder="Contenido..." rows="2"></textarea>
                        <button onclick="saveNote()" class="btn btn-primary btn-upload w-100">
                            <i class="fas fa-save me-2"></i>Guardar Nota
                        </button>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="p-3 border rounded-4 bg-light">
                        <small class="fw-bold text-success"><i class="fas fa-file-upload me-1"></i>NUEVO ARCHIVO</small>
                        <input type="text" id="customFileName" class="form-control my-2 border-0 shadow-sm" placeholder="Nombre opcional...">
                        <input type="file" id="fileInput" class="form-control mb-2 border-0 shadow-sm" accept="image/*,.pdf,.doc,.docx,.xls,.xlsx,.ppt,.pptx,.dwg,.dxf">
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="checkbox" id="compressImages" checked>
                            <label class="form-check-label" for="compressImages">
                                <i class="fas fa-compress-alt me-1"></i>Comprimir im√°genes
                            </label>
                        </div>
                        <button onclick="prepareUpload()" class="btn btn-success btn-upload w-100 text-white">
                            <i class="fas fa-upload me-2"></i>Preparar Subida
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Vistas de categor√≠as -->
    <div id="view-notas" class="view-section">
        <h4 class="mb-3"><i class="fas fa-sticky-note me-2 text-primary"></i>Mis Notas</h4>
        <div id="list-notas" class="row g-3"></div>
    </div>
    
    <div id="view-imagenes" class="view-section">
        <h4 class="mb-3"><i class="fas fa-images me-2 text-success"></i>Galer√≠a de Im√°genes</h4>
        <div id="list-imagenes" class="row g-2"></div>
    </div>
    
    <div id="view-pdf" class="view-section">
        <h4 class="mb-3"><i class="fas fa-file-pdf me-2 text-danger"></i>Documentos PDF</h4>
        <div id="list-pdf" class="row g-2"></div>
    </div>
    
    <div id="view-otros" class="view-section">
        <h4 class="mb-3"><i class="fas fa-archive me-2 text-warning"></i>Otros Archivos</h4>
        <div id="list-otros" class="row g-2"></div>
    </div>
</div>

<script>
    // Configuraci√≥n de Firebase
    const firebaseConfig = {
        apiKey: "AIzaSyDCblC46q3GUlwr7yifm4dZ5FaW6Umzy_0",
        authDomain: "dncaja-9d9a5.firebaseapp.com",
        databaseURL: "https://dncaja-9d9a5-default-rtdb.firebaseio.com",
        projectId: "dncaja-9d9a5",
        storageBucket: "dncaja-9d9a5.firebasestorage.app",
        messagingSenderId: "701237836936",
        appId: "1:701237836936:web:39f0f7f7d455ce9ede733d"
    };
    
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // Variables globales
    let currentNoteId = null;
    let dailyDataUsage = 0;
    let thumbnailsCache = {};
    let pendingUpload = null;

    // ===== FUNCIONES DE UTILIDAD =====
    function showToast(message, type = 'success', duration = 3000) {
        const toast = document.getElementById('toastContainer');
        const toastEl = document.createElement('div');
        toastEl.className = `toast toast-${type}`;
        const icons = { success: 'check-circle', error: 'exclamation-circle', info: 'info-circle', warning: 'exclamation-triangle' };
        toastEl.innerHTML = `<i class="fas fa-${icons[type]} fa-lg"></i><div style="flex:1;">${message}</div>`;
        toast.appendChild(toastEl);
        setTimeout(() => { 
            if (toastEl.parentNode) { 
                toastEl.style.animation = 'slideOutRight 0.3s ease forwards'; 
                setTimeout(() => { 
                    if (toastEl.parentNode) toastEl.remove(); 
                }, 300); 
            } 
        }, duration);
    }

    function showLoader(text) { 
        document.getElementById('loaderText').innerText = text; 
        document.getElementById('loader').style.display = 'flex'; 
    }
    
    function hideLoader() { 
        document.getElementById('loader').style.display = 'none'; 
    }

    function formatFileSize(bytes) { 
        if (bytes < 1024) return bytes + ' B'; 
        if (bytes < 1024*1024) return (bytes/1024).toFixed(1) + ' KB'; 
        return (bytes/(1024*1024)).toFixed(1) + ' MB'; 
    }
    
    function formatDate(timestamp) { 
        if (!timestamp) return 'Sin fecha'; 
        const d = new Date(timestamp); 
        return d.toLocaleDateString(); 
    }

    // ===== FUNCI√ìN DE CONSUMO DIARIO =====
    function updateDataUsage() {
        db.ref('estadisticas/consumo_hoy').once('value').then(snap => {
            const data = snap.val() || { fecha: '', consumo: 0 };
            const hoy = new Date().toDateString();
            
            // Si la fecha guardada no es hoy, reiniciar contador
            if (data.fecha !== hoy) { 
                data.fecha = hoy; 
                data.consumo = 0; 
                // Guardar el reinicio en Firebase
                db.ref('estadisticas/consumo_hoy').set(data);
            }
            
            dailyDataUsage = data.consumo;
            const usagePercent = (dailyDataUsage / 300) * 100;
            
            // Actualizar UI
            document.getElementById('dataUsage').textContent = `${dailyDataUsage.toFixed(2)} MB / 300 MB`;
            document.getElementById('usageFill').style.width = `${Math.min(usagePercent, 100)}%`;
            
            // Cambiar color seg√∫n nivel de consumo
            const fill = document.getElementById('usageFill');
            if (usagePercent > 90) {
                fill.style.background = '#ef4444';
                showToast(`‚ö†Ô∏è Has usado ${dailyDataUsage.toFixed(2)}/300 MB hoy`, "warning", 5000);
            } else if (usagePercent > 70) {
                fill.style.background = '#f59e0b';
            } else {
                fill.style.background = '#22c55e';
            }
        });
    }

    // ===== FUNCI√ìN PARA RASTREAR CONSUMO (AHORA CON TODAS LAS OPERACIONES) =====
    function trackDataUsage(bytes, operation = 'unknown') {
        const hoy = new Date().toDateString();
        db.ref('estadisticas/consumo_hoy').once('value').then(snap => {
            const data = snap.val() || { fecha: '', consumo: 0 };
            
            // Si la fecha cambi√≥, reiniciar
            if (data.fecha !== hoy) { 
                data.fecha = hoy; 
                data.consumo = 0; 
            }
            
            // Sumar los bytes (convertir a MB)
            data.consumo += bytes / (1024 * 1024);
            
            // Guardar y actualizar UI
            db.ref('estadisticas/consumo_hoy').set(data).then(() => {
                dailyDataUsage = data.consumo;
                updateDataUsage();
                console.log(`üìä Transferencia: ${(bytes/1024).toFixed(2)} KB (${operation})`);
            });
        });
    }

    // ===== FUNCIONES DE COMPRESI√ìN =====
    async function compressImage(file, quality = 80) {
        return new Promise((resolve) => {
            const reader = new FileReader();
            reader.onload = function(e) {
                const img = new Image();
                img.onload = function() {
                    const canvas = document.createElement('canvas');
                    canvas.width = img.width;
                    canvas.height = img.height;
                    canvas.getContext('2d').drawImage(img, 0, 0);
                    
                    const compressed = canvas.toDataURL('image/jpeg', quality / 100);
                    const base64Length = compressed.length - 'data:image/jpeg;base64,'.length;
                    const sizeInBytes = Math.floor(base64Length * 0.75);
                    
                    resolve({ 
                        data: compressed, 
                        size: sizeInBytes,
                        dimensions: { width: img.width, height: img.height } 
                    });
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        });
    }

    async function createThumbnail(imageDataUrl, maxSize = 200) {
        return new Promise((resolve) => {
            const img = new Image();
            img.onload = function() {
                const canvas = document.createElement('canvas');
                let width = img.width, height = img.height;
                if (width > height) { 
                    if (width > maxSize) { 
                        height *= maxSize / width; 
                        width = maxSize; 
                    }
                } else { 
                    if (height > maxSize) { 
                        width *= maxSize / height; 
                        height = maxSize; 
                    } 
                }
                canvas.width = width; 
                canvas.height = height;
                canvas.getContext('2d').drawImage(img, 0, 0, width, height);
                resolve(canvas.toDataURL('image/jpeg', 0.8));
            };
            img.src = imageDataUrl;
        });
    }

    // ===== FUNCIONES DEL MODAL DE COMPRESI√ìN =====
    function showCompressionModal(file, originalData, customName) {
        const modal = document.getElementById('compressionModal');
        const preview = document.getElementById('compressionPreview');
        const sizeSpan = document.getElementById('compressionSize');
        const qualityDisplay = document.getElementById('qualityDisplay');
        const slider = document.getElementById('qualitySlider');
        
        // Guardar datos
        pendingUpload = {
            file: file,
            originalData: originalData,
            compressedData: null,
            originalSize: file.size,
            compressedSize: 0,
            customName: customName,
            quality: 80
        };
        
        // Compresi√≥n inicial
        compressImage(file, 80).then(result => {
            pendingUpload.compressedData = result.data;
            pendingUpload.compressedSize = result.size;
            preview.src = result.data;
            sizeSpan.textContent = formatFileSize(result.size);
        });
        
        // Configurar slider (sin parpadeos)
        slider.oninput = async function() {
            const quality = this.value;
            qualityDisplay.textContent = quality + '%';
            pendingUpload.quality = quality;
            
            const result = await compressImage(file, quality);
            pendingUpload.compressedData = result.data;
            pendingUpload.compressedSize = result.size;
            preview.src = result.data;
            sizeSpan.textContent = formatFileSize(result.size);
        };
        
        modal.style.display = 'flex';
    }

    function closeCompressionModal() {
        document.getElementById('compressionModal').style.display = 'none';
    }

    function confirmUpload() {
        closeCompressionModal();
        
        // Mostrar preview en la p√°gina principal
        const previewContainer = document.getElementById('uploadPreviewContainer');
        const fileNameSpan = document.getElementById('pendingFileName');
        const originalSizeSpan = document.getElementById('pendingOriginalSize');
        const compressedSizeSpan = document.getElementById('pendingCompressedSize');
        
        // Determinar nombre del archivo
        const ext = pendingUpload.customName ? 'jpg' : pendingUpload.file.name.split('.').pop();
        const displayName = pendingUpload.customName ? 
            `${pendingUpload.customName}.${ext}` : 
            pendingUpload.file.name;
        
        fileNameSpan.textContent = displayName;
        originalSizeSpan.textContent = formatFileSize(pendingUpload.originalSize);
        compressedSizeSpan.textContent = formatFileSize(pendingUpload.compressedSize);
        
        previewContainer.style.display = 'block';
        
        // Desplazarse suavemente al preview
        previewContainer.scrollIntoView({ behavior: 'smooth', block: 'center' });
        
        showToast(`‚úÖ Imagen comprimida: ${formatFileSize(pendingUpload.originalSize)} ‚û°Ô∏è ${formatFileSize(pendingUpload.compressedSize)}`, "success");
    }

    async function performPendingUpload() {
        if (!pendingUpload) {
            showToast("No hay archivo pendiente", "error");
            return;
        }
        
        showLoader("Subiendo archivo...");
        
        try {
            const finalName = pendingUpload.customName ? 
                `${pendingUpload.customName}.jpg` : 
                pendingUpload.file.name.replace(/\.[^/.]+$/, '') + '.jpg';
            
            const key = db.ref('metadata').push().key;
            const meta = { 
                name: finalName, 
                size: formatFileSize(pendingUpload.compressedSize), 
                bytes: pendingUpload.compressedSize, 
                type: 'image/jpeg', 
                time: Date.now() 
            };
            
            const updates = {};
            updates['/metadata/' + key] = meta;
            updates['/file_storage/' + key + '/data'] = pendingUpload.compressedData;
            
            const thumbnail = await createThumbnail(pendingUpload.compressedData);
            updates['/file_storage/' + key + '/thumb'] = thumbnail;
            
            // ‚úÖ TRACKEO: Subida de archivo (tama√±o real)
            trackDataUsage(pendingUpload.compressedSize, 'subir-archivo');
            
            // ‚úÖ TRACKEO: Metadatos
            trackDataUsage(JSON.stringify(meta).length, 'subir-metadata');
            
            // ‚úÖ TRACKEO: Thumbnail
            trackDataUsage(thumbnail.length * 0.75, 'subir-thumbnail');
            
            await db.ref().update(updates);
            
            // Limpiar
            clearPendingUpload();
            document.getElementById('fileInput').value = "";
            document.getElementById('compressImages').checked = true;
            
            hideLoader();
            showToast(`‚úÖ ${finalName} subido`, "success");
            updateCounts();
            
        } catch (error) {
            hideLoader();
            showToast("Error: " + error.message, "error");
        }
    }

    function clearPendingUpload() {
        pendingUpload = null;
        document.getElementById('uploadPreviewContainer').style.display = 'none';
    }

    // ===== FUNCI√ìN PREPARE UPLOAD =====
    async function prepareUpload() {
        const file = document.getElementById('fileInput').files[0];
        if (!file) { 
            showToast("Selecciona un archivo primero", "error"); 
            return; 
        }
        
        const customName = document.getElementById('customFileName').value.trim();
        const compress = document.getElementById('compressImages').checked;
        
        if (!file.type.startsWith('image/') || !compress) {
            // Subida directa sin compresi√≥n
            showLoader("Subiendo archivo...");
            try {
                const reader = new FileReader();
                const fileData = await new Promise((resolve) => {
                    reader.onload = (e) => resolve(e.target.result);
                    reader.readAsDataURL(file);
                });
                
                const ext = file.name.split('.').pop();
                const finalName = customName ? `${customName}.${ext}` : file.name;
                
                const key = db.ref('metadata').push().key;
                const meta = { 
                    name: finalName, 
                    size: formatFileSize(file.size), 
                    bytes: file.size, 
                    type: file.type, 
                    time: Date.now() 
                };
                
                const updates = {};
                updates['/metadata/' + key] = meta;
                updates['/file_storage/' + key + '/data'] = fileData;
                
                // ‚úÖ TRACKEO: Subida de archivo (tama√±o real)
                trackDataUsage(file.size, 'subir-archivo');
                
                // ‚úÖ TRACKEO: Metadatos
                trackDataUsage(JSON.stringify(meta).length, 'subir-metadata');
                
                if (file.type.startsWith('image/')) {
                    const thumbnail = await createThumbnail(fileData);
                    updates['/file_storage/' + key + '/thumb'] = thumbnail;
                    
                    // ‚úÖ TRACKEO: Thumbnail
                    trackDataUsage(thumbnail.length * 0.75, 'subir-thumbnail');
                }
                
                await db.ref().update(updates);
                
                document.getElementById('fileInput').value = "";
                document.getElementById('customFileName').value = "";
                
                hideLoader();
                showToast(`‚úÖ ${finalName} subido`, "success");
                updateCounts();
                
            } catch (error) {
                hideLoader();
                showToast("Error: " + error.message, "error");
            }
            return;
        }
        
        // Si es imagen y hay que comprimir
        showLoader("Preparando imagen...");
        
        try {
            const reader = new FileReader();
            reader.onload = function(e) {
                const originalData = e.target.result;
                showCompressionModal(file, originalData, customName);
                hideLoader();
            };
            reader.readAsDataURL(file);
        } catch (error) { 
            hideLoader(); 
            showToast("Error al procesar imagen: " + error.message, "error"); 
        }
    }

    // ===== FUNCIONES DE VISTA PREVIA CON MANTENER PULSADO =====
    function openPreviewModal(originalUrl, compressedUrl) {
        const modal = document.getElementById('previewModal');
        const originalImg = document.getElementById('modalOriginalImage');
        const compressedImg = document.getElementById('modalCompressedImage');
        
        originalImg.src = originalUrl;
        compressedImg.src = compressedUrl;
        
        originalImg.style.opacity = '0';
        compressedImg.style.opacity = '1';
        
        modal.style.display = 'flex';
    }

    function showOriginal() {
        const originalImg = document.getElementById('modalOriginalImage');
        const compressedImg = document.getElementById('modalCompressedImage');
        originalImg.style.opacity = '1';
        compressedImg.style.opacity = '0';
    }

    function hideOriginal() {
        const originalImg = document.getElementById('modalOriginalImage');
        const compressedImg = document.getElementById('modalCompressedImage');
        originalImg.style.opacity = '0';
        compressedImg.style.opacity = '1';
    }

    function closePreviewModal() {
        document.getElementById('previewModal').style.display = 'none';
    }

    // ===== FUNCIONES DE CONTEO (CON TRACKEO) =====
    function updateCounts() {
        // ‚úÖ TRACKEO: Lectura de notas
        db.ref('notas').once('value', s => { 
            trackDataUsage(JSON.stringify(s.val()).length, 'leer-notas');
            document.getElementById('count-notas').innerText = s.numChildren(); 
        });
        
        // ‚úÖ TRACKEO: Lectura de metadatos
        db.ref('metadata').once('value', s => {
            trackDataUsage(JSON.stringify(s.val()).length, 'leer-metadata');
            
            let img = 0, pdf = 0, otr = 0;
            s.forEach(child => {
                const name = child.val().name.toLowerCase();
                if (name.endsWith('.pdf')) pdf++;
                else if (/\.(jpg|jpeg|png|gif|webp|bmp|svg|tiff)$/i.test(name)) img++;
                else otr++;
            });
            document.getElementById('count-pdf').innerText = pdf;
            document.getElementById('count-imagenes').innerText = img;
            document.getElementById('count-otros').innerText = otr;
        });
    }

    function showView(v) { 
        document.querySelectorAll('.view-section').forEach(s => s.classList.remove('active-view')); 
        document.getElementById('view-'+v).classList.add('active-view'); 
        document.getElementById('btnBack').classList.toggle('d-none', v==='home'); 
        document.getElementById('searchContainer').classList.toggle('d-none', v==='home'); 
    }

    // ===== FUNCIONES DE NOTAS (CON TRACKEO) =====
    function saveNote() {
        const t = document.getElementById('noteTitle').value.trim() || 'Nota sin t√≠tulo';
        const c = document.getElementById('noteContent').value.trim();
        if (!c) { 
            showToast("Escribe el contenido", "error"); 
            return; 
        }
        
        showLoader("Guardando nota...");
        const noteData = { title: t, content: c, time: Date.now(), updated: Date.now() };
        
        // ‚úÖ TRACKEO: Escritura de nota
        trackDataUsage(JSON.stringify(noteData).length, 'guardar-nota');
        
        db.ref('notas').push(noteData).then(() => { 
            document.getElementById('noteTitle').value = ""; 
            document.getElementById('noteContent').value = ""; 
            hideLoader(); 
            showToast("Nota guardada", "success"); 
            updateCounts(); 
        });
    }

    function openNoteEditor(id) {
        // ‚úÖ TRACKEO: Lectura de nota espec√≠fica
        db.ref('notas/' + id).once('value').then(snap => {
            trackDataUsage(JSON.stringify(snap.val()).length, 'leer-nota');
            
            const note = snap.val();
            if (note) { 
                currentNoteId = id; 
                document.getElementById('editNoteTitle').value = note.title || ''; 
                document.getElementById('editNoteContent').value = note.content || ''; 
                document.getElementById('noteModal').style.display = 'flex'; 
            }
        });
    }

    function saveEditedNote() {
        if (!currentNoteId) return;
        
        const newTitle = document.getElementById('editNoteTitle').value.trim() || 'Nota sin t√≠tulo';
        const newContent = document.getElementById('editNoteContent').value.trim();
        
        if (!newContent) { 
            showToast("El contenido no puede estar vac√≠o", "error"); 
            return; 
        }
        
        showLoader("Guardando cambios...");
        const updateData = { title: newTitle, content: newContent, updated: Date.now() };
        
        // ‚úÖ TRACKEO: Actualizaci√≥n de nota
        trackDataUsage(JSON.stringify(updateData).length, 'editar-nota');
        
        db.ref('notas/' + currentNoteId).update(updateData).then(() => { 
            hideLoader(); 
            closeModal(); 
            showToast("Nota actualizada", "success"); 
            loadAndShow('notas'); 
        });
    }

    function closeModal() { 
        document.getElementById('noteModal').style.display = 'none'; 
        currentNoteId = null; 
    }

    // ===== FUNCIONES DE ARCHIVOS (CON TRACKEO) =====
    function getFileIcon(name) {
        const ext = name.split('.').pop().toLowerCase();
        if (ext === 'pdf') return { icon: 'file-pdf', class: 'file-pdf' };
        if (['mp3','wav','m4a','ogg','flac','aac'].includes(ext)) return { icon: 'file-audio', class: 'file-audio' };
        if (['doc','docx','rtf'].includes(ext)) return { icon: 'file-word', class: 'file-word' };
        if (['xls','xlsx','csv'].includes(ext)) return { icon: 'file-excel', class: 'file-excel' };
        if (['ppt','pptx'].includes(ext)) return { icon: 'file-powerpoint', class: 'file-powerpoint' };
        if (['dwg','dxf','dwt','bak','dws','dwl','dwf','dwfx'].includes(ext)) return { icon: 'file-cad', class: 'file-cad' };
        if (['jpg','jpeg','png','gif','webp','bmp','svg','tiff'].includes(ext)) return { icon: 'image', class: '' };
        return { icon: 'file', class: 'file-other' };
    }

    function downloadFile(id, name) {
        showLoader("Preparando descarga...");
        
        // ‚úÖ TRACKEO: Descarga de archivo
        db.ref('file_storage/' + id + '/data').once('value').then(s => {
            if (!s.val()) { 
                hideLoader(); 
                showToast("Archivo no encontrado", "error"); 
                return; 
            }
            
            // Trackear consumo de descarga (tama√±o del archivo)
            trackDataUsage(JSON.stringify(s.val()).length, 'descargar-'+name);
            
            const a = document.createElement("a"); 
            a.href = s.val(); 
            a.download = name; 
            document.body.appendChild(a); 
            a.click(); 
            document.body.removeChild(a);
            
            hideLoader(); 
            showToast(`‚úÖ ${name} descargado`, "success");
        }).catch(error => { 
            hideLoader(); 
            showToast("Error: " + error.message, "error"); 
        });
    }

    function confirmDelete(mode, id) {
        const itemType = mode === 'notas' ? 'nota' : 'archivo';
        if (!confirm(`¬øEliminar esta ${itemType}?`)) return;
        
        showLoader("Eliminando...");
        
        if (mode === 'notas') {
            db.ref('notas/' + id).remove().then(() => { 
                // ‚úÖ TRACKEO: Eliminaci√≥n (1 byte simb√≥lico)
                trackDataUsage(1, 'eliminar-nota');
                hideLoader(); 
                showToast("‚úÖ Nota eliminada", "success"); 
                loadAndShow('notas'); 
                updateCounts(); 
            }).catch(error => { 
                hideLoader(); 
                showToast("‚ùå Error: " + error.message, "error"); 
            });
        } else {
            const updates = {};
            updates['/metadata/' + id] = null;
            updates['/file_storage/' + id + '/data'] = null;
            updates['/file_storage/' + id + '/thumb'] = null;
            
            db.ref().update(updates).then(() => {
                // ‚úÖ TRACKEO: Eliminaci√≥n (1 byte simb√≥lico)
                trackDataUsage(1, 'eliminar-archivo');
                
                hideLoader();
                if (thumbnailsCache[id]) delete thumbnailsCache[id];
                showToast("‚úÖ Archivo eliminado", "success");
                
                const activeView = document.querySelector('.view-section.active-view').id.replace('view-','');
                if (activeView !== 'home') loadAndShow(activeView);
                updateCounts();
            }).catch(error => { 
                hideLoader(); 
                showToast("‚ùå Error: " + error.message, "error"); 
            });
        }
    }

    async function loadOptimizedImage(id, thumbId) {
        try {
            // ‚úÖ TRACKEO: Carga de thumbnail
            const thumbSnapshot = await db.ref('file_storage/' + id + '/thumb').once('value');
            trackDataUsage(JSON.stringify(thumbSnapshot.val()).length, 'cargar-thumbnail');
            
            let thumbnail = thumbSnapshot.val();
            const thumbElement = document.getElementById(thumbId);
            
            if (!thumbElement) return;
            
            if (thumbnail) {
                thumbnailsCache[id] = thumbnail;
                thumbElement.innerHTML = `<img src="${thumbnail}" class="img-thumb" onclick="openImageModalFromThumb('${id}')" onerror="this.src='https://placehold.co/200x200?text=Error'">`;
            } else {
                thumbElement.innerHTML = `<div class="img-thumb d-flex flex-column align-items-center justify-content-center bg-light" onclick="openImageModalFromThumb('${id}')"><i class="fas fa-image fa-2x text-muted"></i><small class="text-center fw-bold">Sin vista</small></div>`;
            }
        } catch (error) {
            console.error('Error loading image:', error);
            const thumbElement = document.getElementById(thumbId);
            if (thumbElement) {
                thumbElement.innerHTML = `<div class="img-thumb d-flex flex-column align-items-center justify-content-center bg-light" onclick="openImageModalFromThumb('${id}')"><i class="fas fa-exclamation-triangle fa-2x text-danger"></i><small class="text-center fw-bold">Error</small></div>`;
            }
        }
    }

    function openImageModalFromThumb(id) {
        showLoader("Cargando imagen...");
        
        // ‚úÖ TRACKEO: Apertura de imagen completa
        db.ref('file_storage/' + id + '/data').once('value').then(s => {
            trackDataUsage(JSON.stringify(s.val()).length, 'abrir-imagen');
            
            if (s.val()) { 
                openImageModal(s.val()); 
                hideLoader(); 
            }
        }).catch(() => { 
            hideLoader(); 
            showToast("Error al cargar la imagen", "error"); 
        });
    }

    function openImageModal(imageUrl) { 
        document.getElementById('modalImage').src = imageUrl; 
        document.getElementById('imageModal').style.display = 'flex'; 
    }

    function closeImageModal() { 
        document.getElementById('imageModal').style.display = 'none'; 
        document.getElementById('modalImage').src = ''; 
    }

    // ===== FUNCI√ìN LOAD AND SHOW (CON TRACKEO) =====
    function loadAndShow(type) {
        showLoader("Cargando...");
        const listDiv = document.getElementById('list-' + type);
        if (!listDiv) { 
            console.error('‚ùå No se encontr√≥ el contenedor para', type); 
            return; 
        }
        listDiv.innerHTML = "";

        if (type !== 'imagenes') thumbnailsCache = {};

        document.getElementById('searchContainer').classList.remove('d-none');
        document.getElementById('searchInput').value = '';

        const path = (type === 'notas') ? 'notas' : 'metadata';

        // ‚úÖ TRACKEO: Carga de lista
        db.ref(path).once('value').then(snap => {
            trackDataUsage(JSON.stringify(snap.val()).length, 'cargar-' + type);
            
            const data = snap.val();
            showView(type);

            if (!data) {
                listDiv.innerHTML = `<div class="col-12 text-center text-muted p-5"><i class="fas fa-inbox fa-3x mb-3 opacity-50"></i><h6 class="fw-bold">No hay elementos</h6><small>A√±ade algunos elementos para comenzar</small></div>`;
                hideLoader();
                return;
            }

            const items = [];
            const entries = Object.entries(data).reverse();

            if (type === 'notas') {
                entries.forEach(([id, item]) => items.push({ id, item }));
            } else {
                entries.forEach(([id, item]) => {
                    if (!item || !item.name) return;
                    const ext = item.name.split('.').pop().toLowerCase();
                    const esImagen = ['jpg','jpeg','png','gif','webp','bmp','svg','tiff'].includes(ext);
                    const esPdf = (ext === 'pdf');
                    
                    if (type === 'pdf' && esPdf) items.push({ id, item });
                    else if (type === 'imagenes' && esImagen) items.push({ id, item });
                    else if (type === 'otros' && !esPdf && !esImagen) items.push({ id, item });
                });
            }

            if (items.length === 0) {
                listDiv.innerHTML = `<div class="col-12 text-center text-muted p-5"><i class="fas fa-inbox fa-3x mb-3 opacity-50"></i><h6 class="fw-bold">No hay elementos en esta categor√≠a</h6></div>`;
                hideLoader();
                return;
            }

            items.forEach(({ id, item }) => {
                if (!document.getElementById(`item-${type}-${id}`)) {
                    renderItem(type, id, item, listDiv);
                }
            });

            hideLoader();
        }).catch(error => {
            hideLoader();
            showToast('Error al cargar datos: ' + error.message, 'error');
        });
    }

    function renderItem(type, id, item, container) {
        const col = document.createElement('div');
        col.id = `item-${type}-${id}`;
        col.dataset.id = id;

        if (type === 'notas') {
            col.className = 'col-12 col-md-4';
            col.innerHTML = `
                <div class="card note-card p-3 h-100">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <h6 class="fw-bold text-primary mb-1 flex-grow-1">${item.title || 'Sin T√≠tulo'}</h6>
                        <small class="text-muted">${formatDate(item.time)}</small>
                    </div>
                    <p class="small mb-3 text-truncate-multiline" style="--lines: 3">${(item.content || '').substring(0,150)}...</p>
                    <div class="d-flex gap-2 mt-auto">
                        <button class="btn btn-sm btn-outline-primary flex-grow-1" onclick="openNoteEditor('${id}')"><i class="fas fa-edit me-1"></i>Editar</button>
                        <button class="btn btn-sm btn-outline-danger" onclick="confirmDelete('notas','${id}')"><i class="fas fa-trash"></i></button>
                    </div>
                </div>`;
        } else if (type === 'imagenes') {
            col.className = 'col-6 col-md-3 col-lg-2';
            const thumbId = `thumb-${id}-${Date.now()}`;
            col.innerHTML = `
                <div class="card p-1 border-0 shadow-sm rounded-3 overflow-hidden">
                    <div id="${thumbId}" class="thumbnail-container" style="width:100%; height:120px;">
                        <div class="img-thumb d-flex flex-column align-items-center justify-content-center bg-light" style="height:100%;">
                            <i class="fas fa-image fa-2x text-muted mb-2"></i>
                            <small class="text-center fw-bold">Cargando...</small>
                        </div>
                    </div>
                    <div class="p-1 d-flex justify-content-between align-items-center">
                        <small class="text-truncate fw-bold" style="max-width:80%" title="${item.name}">${item.name}</small>
                        <div class="d-flex gap-1">
                            <button class="btn btn-sm p-0 text-primary" onclick="downloadFile('${id}', '${item.name}')" title="Descargar"><i class="fas fa-download"></i></button>
                            <button class="btn btn-sm p-0 text-danger" onclick="confirmDelete('file','${id}')" title="Eliminar"><i class="fas fa-times"></i></button>
                        </div>
                    </div>
                </div>`;
            setTimeout(() => { loadOptimizedImage(id, thumbId); }, 10);
        } else {
            const fileIcon = getFileIcon(item.name);
            const colClass = type === 'pdf' ? 'col-6 col-md-4' : 'col-6 col-md-4 col-lg-3';
            col.className = colClass;
            col.innerHTML = `
                <div class="card p-3 border-0 shadow-sm rounded-4 h-100">
                    <div class="${fileIcon.class} file-icon"><i class="fas fa-${fileIcon.icon} fa-2x"></i></div>
                    <div class="text-center mb-3">
                        <b class="d-block text-truncate" title="${item.name}">${item.name}</b>
                        <small class="text-muted">${item.size} ‚Ä¢ ${formatDate(item.time)}</small>
                    </div>
                    <div class="d-flex gap-2 justify-content-center mt-auto">
                        <button onclick="downloadFile('${id}', '${item.name}')" class="btn btn-sm btn-primary" title="Descargar"><i class="fas fa-download me-1"></i>Descargar</button>
                        <button onclick="confirmDelete('file','${id}')" class="btn btn-sm btn-danger" title="Eliminar"><i class="fas fa-trash"></i></button>
                    </div>
                </div>`;
        }
        container.appendChild(col);
    }

    // ===== EVENT LISTENERS =====
    document.addEventListener('DOMContentLoaded', function() {
        // Inicializar contadores y consumo
        updateCounts(); 
        updateDataUsage();
        
        // Actualizar consumo cada 30 segundos
        setInterval(updateDataUsage, 30000);
        
        const uploadZone = document.getElementById('uploadZone');
        
        uploadZone.addEventListener('dragover', (e) => { 
            e.preventDefault(); 
            uploadZone.classList.add('drag-over');
        });
        
        uploadZone.addEventListener('dragleave', () => { 
            uploadZone.classList.remove('drag-over');
        });
        
        uploadZone.addEventListener('drop', (e) => { 
            e.preventDefault(); 
            uploadZone.classList.remove('drag-over');
            if (e.dataTransfer.files.length) { 
                document.getElementById('fileInput').files = e.dataTransfer.files; 
                prepareUpload(); 
            } 
        });
        
        document.addEventListener('keydown', function(e) { 
            if(e.key === 'Escape') { 
                closeModal(); 
                closeImageModal(); 
                closeCompressionModal(); 
                closePreviewModal();
            } 
        });

        document.getElementById('searchInput').addEventListener('input', function(e) {
            const term = e.target.value.toLowerCase();
            const activeView = document.querySelector('.view-section.active-view').id.replace('view-','');
            document.querySelectorAll(`#list-${activeView} > div`).forEach(item => { 
                item.style.display = item.textContent.toLowerCase().includes(term) ? '' : 'none'; 
            });
        });

        document.getElementById('imageModal').addEventListener('click', function(e) { 
            if(e.target === this) closeImageModal(); 
        });

        document.getElementById('previewModal').addEventListener('click', function(e) { 
            if(e.target === this) closePreviewModal(); 
        });

        document.getElementById('compressionModal').addEventListener('click', function(e) { 
            if(e.target === this) closeCompressionModal(); 
        });

        document.getElementById('noteModal').addEventListener('click', function(e) { 
            if(e.target === this) closeModal(); 
        });
    });
</script>
</body>
</html>
